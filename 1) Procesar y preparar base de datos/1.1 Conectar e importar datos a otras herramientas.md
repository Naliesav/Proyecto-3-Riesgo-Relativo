### **Procesamiento y análisis:**

1. **Conectar/importar datos a otras herramientas.**
    a. Descargar y descomprimir data set.
    b. Subir archivos a BigQuery en formato CSV.

![Untitled](https://github.com/user-attachments/assets/702ec3a4-edba-4761-a305-dd64cb230b01)




7. **Crear nuevas variables.**

Durante el proceso creamos las variables *Real_Estate, Other* y *Total_Loans*, ahora queremos crear una nueva variable sobre el número de veces que el cliente se retrasó en el pago de un préstamo. Contamos con 3 variables para eso:

- more_90_days_overdue
- number_times_delayed_payment_loan_30_59_days
- number_times_delayed_payment_loan_60_89_days

Queremos una nueva que trate la ponderación de retrasos para darle más importancia a los retrasos más largos, para eso se asigna un valor diferente a cada tipo de retraso. Por ejemplo, los retrasos de 30-59 días se ponderan con 1, los de 60-89 días con 2, y los de más de 90 días con 3, reflejando su mayor gravedad.

```sql
SELECT 
    user_id,
    (1 * number_times_delayed_payment_loan_30_59_days + 2 * number_times_delayed_payment_loan_60_89_days + 3 * more_90_days_overdue) AS weighted_delays
FROM 
    `proyecto-riesgo-relativo-3.prestamos.combined_view`
```

Teniendo esta fórmula podemos también tener la oportunidad de crear las variables de % de: debt_ratio y using_lines_not_secured_personal_assets.

```sql
SELECT 
    user_id,
    (1 * number_times_delayed_payment_loan_30_59_days + 2 * number_times_delayed_payment_loan_60_89_days + 3 * more_90_days_overdue) AS weighted_delays,
    
    FORMAT("%.2f%%", debt_ratio * 100) AS debt_ratio_percentage,
    CASE
        WHEN debt_ratio > 1 THEN 'Monitorize'
        ELSE 'Normal'
    END AS monitoring_status_debt_ratio,
    
    FORMAT("%.2f%%", using_lines_not_secured_personal_assets * 100) AS lines_not_secured_percentage,
    CASE
        WHEN using_lines_not_secured_personal_assets > 1 THEN 'Monitorize'
        ELSE 'Normal'
    END AS monitoring_status_lines_not_secured
    
FROM 
    `proyecto-riesgo-relativo-3.prestamos.combined_view`;
```

Crearemos una nueva tabla:

```sql
CREATE TABLE `proyecto-riesgo-relativo-3.prestamos.nuevas_variables` AS
SELECT 
    user_id,
    (1 * number_times_delayed_payment_loan_30_59_days + 2 * number_times_delayed_payment_loan_60_89_days + 3 * more_90_days_overdue) AS weighted_delays,
    
    FORMAT("%.2f%%", debt_ratio * 100) AS debt_ratio_percentage,
    CASE
        WHEN debt_ratio > 1 THEN 'Monitorize'
        ELSE 'Normal'
    END AS monitoring_status_debt_ratio,
    
    FORMAT("%.2f%%", using_lines_not_secured_personal_assets * 100) AS lines_not_secured_percentage,
    CASE
        WHEN using_lines_not_secured_personal_assets > 1 THEN 'Monitorize'
        ELSE 'Normal'
    END AS monitoring_status_lines_not_secured
    
FROM 
    `proyecto-riesgo-relativo-3.prestamos.combined_view`;
```

Visualización de la nueva tabla:

![image (4)](https://github.com/user-attachments/assets/f8c26dd0-66d6-4cd8-ab6e-f92821c8f402)

Crearemos unas variables categóricas para *age*, *Total_Loans, last_month_salary y weighted_delays* por medio de los cuartiles:

```sql
CREATE TABLE `proyecto-riesgo-relativo-3.prestamos.nuevas_variables_categoricas` AS
WITH cuartiles AS (
  SELECT
    user_id,
    age,
    last_month_salary,
    Total_Loans,
    weighted_delays
  FROM
    `proyecto-riesgo-relativo-3.prestamos.combined_view`
)

SELECT
  user_id,
  age,
  last_month_salary,
  Total_Loans,
  weighted_delays,
  
  CASE
    WHEN age BETWEEN 18 AND 39 THEN 'ADULTO JOVEN'
    WHEN age BETWEEN 40 AND 64 THEN 'ADULTO MEDIO'
    WHEN age BETWEEN 65 AND 74 THEN 'ADULTO MAYOR'
    ELSE 'SENIOR'
  END AS cat_grupo_etario,

  CASE
    WHEN Total_Loans BETWEEN 0 AND 4 THEN 'BAJOS'
    WHEN Total_Loans BETWEEN 5 AND 7 THEN 'MODERADO'
    WHEN Total_Loans BETWEEN 8 AND 10 THEN 'ALTO'
    ELSE 'MUY ALTO'
  END AS cat_total_prestamos,

  CASE
    WHEN weighted_delays = 0 THEN 'SIN MORA'
    WHEN weighted_delays BETWEEN 1 AND 2 THEN 'BAJO'
    WHEN weighted_delays BETWEEN 3 AND 5 THEN 'MODERADO'
    WHEN weighted_delays BETWEEN 6 AND 8 THEN 'ALTO'
    ELSE 'MUY ALTO'
  END AS cat_weighted_delays,

  CASE
    WHEN last_month_salary BETWEEN 1300 AND 3900 THEN 'BAJOS'
    WHEN last_month_salary BETWEEN 3901 AND 5400 THEN 'MODERADO'
    WHEN last_month_salary BETWEEN 5401 AND 7499 THEN 'ALTO'
    ELSE 'MUY ALTO'
  END AS cat_salary
FROM
  cuartiles

```

Aquí los categorizamos y creamos una nueva tabla

---

Modificaremos la variable *default_flag* ya que se notó que al tener dos morosidades algún cliente lo muestra como buen pagador (0) por ende haremos que cuente a todos los clientes desde su primera morosidad como mal pagadores (1)

```sql
CREATE TABLE `proyecto-riesgo-relativo-3.prestamos.default_modificado` AS
SELECT
user_id,
number_times_delayed_payment_loan_30_59_days,
number_times_delayed_payment_loan_60_89_days,
more_90_days_overdue,
  CASE
    WHEN number_times_delayed_payment_loan_30_59_days > 0
      OR number_times_delayed_payment_loan_60_89_days > 0
      OR more_90_days_overdue > 0
    THEN 1
    ELSE 0
  END AS default_flag_actualizado
FROM `proyecto-riesgo-relativo-3.prestamos.combined_view`;
```

Con esto se solucionará el problema.

8. **Unir tablas.**

Modificando nuestra view que habíamos creado anteriormente, agregaremos las nuevas modificaciones, variables y ordenaremos:

```sql
WITH combined_view AS (
    SELECT
        d.user_id,
        ui.age,
        vc.cat_grupo_etario,
        ui.last_month_salary,
        vc.cat_salary,
        ui.number_dependents,
        d.default_flag_actualizado,
        ld.using_lines_not_secured_personal_assets,
        nv.lines_not_secured_percentage,
        nv.monitoring_status_lines_not_secured,
        ld.number_times_delayed_payment_loan_30_59_days,
        ld.number_times_delayed_payment_loan_60_89_days,
        ld.more_90_days_overdue,
        nv.weighted_delays,
        vc.cat_weighted_delays,
        ld.debt_ratio,
        nv.debt_ratio_percentage,
        nv.monitoring_status_debt_ratio,
        lo.Real_Estate,
        lo.Other,
        lo.Total_Loans,
        vc.cat_total_prestamos
        
    FROM
        `proyecto-riesgo-relativo-3.prestamos.default_modificado` d
    JOIN
        `proyecto-riesgo-relativo-3.prestamos.loans_detail` ld ON d.user_id = ld.user_id
    JOIN
        `proyecto-riesgo-relativo-3.prestamos.user_info2` ui ON d.user_id = ui.user_id
    JOIN
        `proyecto-riesgo-relativo-3.prestamos.loans_outstanding_ordenado` lo ON d.user_id = lo.user_id
    JOIN
        `proyecto-riesgo-relativo-3.prestamos.nuevas_variables` nv ON d.user_id = nv.user_id
    JOIN
        `proyecto-riesgo-relativo-3.prestamos.nuevas_variables_categoricas` vc ON d.user_id = vc.user_id
        
)
SELECT
    *
FROM
    combined_view
WHERE
    user_id != 21979
```

Agregaremos también la exclusión de un user_id que no es necesario tener en la información ya que es un outlier muy notorio. Es el outlier que mencionamos que está cerca de los 100 días de mora e las 3 variables.

Aquí parte de la visualización (no está completa):

![image (5)](https://github.com/user-attachments/assets/a2b7ec98-e9ba-4cb7-9ea5-ca28824f3d95)

